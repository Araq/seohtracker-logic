<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nimrod. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module l_db</title>
<style type="text/css">

span.DecNumber {color: blue}
span.BinNumber {color: blue}
span.HexNumber {color: blue}
span.OctNumber {color: blue}
span.FloatNumber {color: blue}
span.Identifier  {color: black}
span.Keyword {font-weight: bold}
span.StringLit {color: blue}
span.LongStringLit {color: blue}
span.CharLit {color: blue}
span.EscapeSequence {color: black}
span.Operator {color: black}
span.Punctuation {color: black}
span.Comment, span.LongComment {font-style:italic; color: green}
span.RegularExpression  {color: DarkViolet}
span.TagStart {color: DarkViolet}
span.TagEnd {color: DarkViolet}
span.Key  {color: blue}
span.Value  {color: black}
span.RawData {color: blue}
span.Assembler  {color: blue}
span.Preprocessor {color: DarkViolet}
span.Directive  {color: DarkViolet}
span.Command, span.Rule, span.Hyperlink, span.Label, span.Reference, 
span.Other  {color: black}

div.navigation {
  -moz-border-radius: 5px 5px 5px 5px;
  float: left; 
  width: 30%;
  margin: 0; padding: 0;
  border: 3px outset #7F7F7F;
  background-color: #7F7F7F;
}

div.navigation ul {
  list-style-type: none;
  padding-left: 1em;
}
div.navigation ul li a, div.navigation ul li a:visited {
  font-weight: bold;
  color: #FFFFFF;
  text-decoration: none;
}
div.navigation ul li a:hover {
  font-weight: bold;
  text-decoration: none;
  color: gold;
}

div.content {
  margin-left: 30%;
  padding: 0 1em;
  border-left: 4em;
}

dl.item dd, dl.item dd p {
  margin-top:3px;
}
dl.item dd pre {
  margin-left: 15pt;
  border: 0px;
}
dl.item dt, dl.item dt pre {
  margin:  20pt 0 0 5pt;
}

pre, span.tok {
  background-color: #F9F9F9;
  border-color: #C4C4C4;
  border-style: solid;
  border-width: 1px 1px 1px 2px;
  color: black;
  line-spacing: 110%;
  padding: 2px;
}

span.red {
  color: #A80000;
}

hr {background-color:#9D9D9D; border:0 none; color:#9D9D9D; height:1px; width:100%;}

/*
:Author: David Goodger
:Contact: goodger@python.org
:Date: Date: 2006-05-21 22:44:42 +0200 (Sun, 21 May 2006)
:Revision: Revision: 4564
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/
/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th { border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first { margin-top: 0 ! important }
.last, .with-subtitle { margin-bottom: 0 ! important }
.hidden { display: none }
a.toc-backref { text-decoration: none ; color: black }
blockquote.epigraph { margin: 2em 5em ; }
dl.docutils dd { margin-bottom: 0.5em }
div.abstract { margin: 2em 5em }
div.abstract p.topic-title { font-weight: bold ; text-align: center }
div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ; border: medium outset ; padding: 1em }
div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title { font-weight: bold ; font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title { color: red ; font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication { margin: 2em 5em ; text-align: center ; font-style: italic }
div.dedication p.topic-title { font-weight: bold ; font-style: normal }
div.figure { margin-left: 2em ; margin-right: 2em }
div.footer, div.header { clear: both; font-size: smaller }
div.line-block { display: block ; margin-top: 1em ; margin-bottom: 1em }
div.line-block div.line-block { margin-top: 0 ; margin-bottom: 0 ;
  margin-left: 1.5em }
div.sidebar { margin-left: 1em ; border: medium outset ;
  padding: 1em ; background-color: #ffffee ; /*width: 40% ;*/ float: right ;
  clear: right }

div.sidebar p.rubric { font-family: sans-serif ; font-size: medium }
div.system-messages { margin: 5em }
div.system-messages h1 { color: red }
div.system-message { border: medium outset ; padding: 1em }
div.system-message p.system-message-title { color: red ; font-weight: bold }
div.topic { margin: 2em;}
h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }
h1.title { text-align: center }
h2.subtitle { text-align: center }
/* hr.docutils { width: 75% } */
img.align-left { clear: left }
img.align-right { clear: right }
ol.simple, ul.simple { margin-bottom: 1em }
ol.arabic { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }
p.attribution { text-align: right ; margin-left: 50% }
p.caption { font-style: italic }
p.credits { font-style: italic ; font-size: smaller }
p.label { white-space: nowrap }
p.rubric { font-weight:bold;font-size:larger;color:maroon;text-align:center}
p.sidebar-title {font-family: sans-serif ;font-weight: bold ;font-size: larger }
p.sidebar-subtitle {font-family: sans-serif ; font-weight: bold }
p.topic-title {
font-weight: bold;
background-color: #6D6D6D;
border-bottom: 1px solid #000000;
border-top: 1px solid black;
color: white;
text-align: center;
margin: 0;
}
pre.address { margin-bottom: 0;margin-top:0;font-family:serif;font-size:100% }
pre.literal-block, pre.doctest-block {margin-left: 2em ;margin-right: 2em }
span.classifier {font-family: sans-serif;font-style: oblique }
span.classifier-delimiter {font-family: sans-serif;font-weight: bold }
span.interpreted {font-family: sans-serif }
span.option {white-space: nowrap }
span.pre {white-space: pre }
span.problematic {color: red }
span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation { border-left: solid 1px gray; margin-left: 1px }
table.docinfo {margin: 2em 4em }
table.docutils {margin-top: 0.5em;margin-bottom: 0.5em; border: 0 solid #9d9d9d; border-collapse: collapse; }
table.footnote {border-left: solid 1px black;margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {padding-left: 0.5em;padding-right: 0.5em;
  vertical-align: top;}

table.docutils td, table.docutils th { border-bottom:1px solid #9D9D9D; }
/* color: #4d4d4d} */

/* table.docutils td:hover, table.docinfo td:hover {color: #000000} */
  

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold;text-align: left;white-space: nowrap;padding-left: 0 }
  
table.docutils th
{
color: black;
font-weight:normal;
background-color: #E3E3E3;
border-top: 1px solid #1d1d1d;
border-bottom: 1px solid #1d1d1d;
}
  
h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {font-size: 100% }
ul.auto-toc { list-style-type: none }
/*a.reference { color: #E00000; font-weight:bold;}
a.reference:hover {color: #E00000;background-color: #ffff00;display: margin;
  font-weight:bold;}*/

</style>

</head>
<body>
<div class="document" id="documentId">
<h1 class="title">Module l_db</h1>
<div class="navigation" id="navigation">
<ul class="simple">
<li>
  <a class="reference" href="#6" id="56">Imports</a>
  <ul class="simple">
    
  </ul>
</li>
<li>
  <a class="reference" href="#12" id="62">Procs</a>
  <ul class="simple">
      <li><a class="reference" href="#open_database,"
    title="open_database*(path): Tdb_conn"><wbr />open_<wbr />database</a></li>
  <li><a class="reference" href="#update,Tdb_conn"
    title="update*(db_conn: Tdb_conn)"><wbr />update</a></li>
  <li><a class="reference" href="#add_weight,Tdb_conn,float,Weight_type,TTime"
    title="add_weight*(conn: Tdb_conn; weight: float; typ: Weight_type; 
            ddate: TTime = TTime(0)): tuple[w: PWeight, pos: int]"><wbr />add_<wbr />weight</a></li>
  <li><a class="reference" href="#remove_weight,Tdb_conn,PWeight"
    title="remove_weight*(conn: Tdb_conn; weight: PWeight): int64"><wbr />remove_<wbr />weight</a></li>
  <li><a class="reference" href="#update_weight,Tdb_conn,PWeight,float,Weight_type"
    title="update_weight*(conn: Tdb_conn; weight: PWeight; value: float; typ: Weight_type): int64"><wbr />update_<wbr />weight</a></li>
  <li><a class="reference" href="#update_date,Tdb_conn,PWeight,TTime"
    title="update_date*(conn: Tdb_conn; weight: PWeight; value: TTime): int"><wbr />update_<wbr />date</a></li>
  <li><a class="reference" href="#get_num_weights,Tdb_conn"
    title="get_num_weights*(conn: Tdb_conn): int"><wbr />get_<wbr />num_<wbr />weights</a></li>
  <li><a class="reference" href="#get_weights_page,Tdb_conn"
    title="get_weights_page*(conn: Tdb_conn; last_known_id = - 1; page_size = 5): seq[
    PWeight]"><wbr />get_<wbr />weights_<wbr />page</a></li>
  <li><a class="reference" href="#import_csv_into_db,TDbConn,seq[PWeight],bool"
    title="import_csv_into_db*(conn: TDbConn; values: seq[PWeight]; replace: bool): bool"><wbr />import_<wbr />csv_<wbr />into_<wbr />db</a></li>
  <li><a class="reference" href="#timegm,Ttm"
    title="timegm*(a1: var Ttm): TTime"><wbr />timegm</a></li>
  <li><a class="reference" href="#parse_csv,string"
    title="parse_csv*(input_filename: string): seq[PWeight]"><wbr />parse_<wbr />csv</a></li>
  <li><a class="reference" href="#build_csv_file,TDbConn,string"
    title="build_csv_file*(conn: TDbConn; out_filename: string): bool"><wbr />build_<wbr />csv_<wbr />file</a></li>
  <li><a class="reference" href="#set_csv_export_gmt_time,bool"
    title="set_csv_export_gmt_time*(use_gmt: bool)"><wbr />set_<wbr />csv_<wbr />export_<wbr />gmt_<wbr />time</a></li>

  </ul>
</li>

</ul>
</div>
<div class="content" id="content">
<p><a class="reference external" href="https://github.com/gradha/seohtracker-logic">Seohtracker logic</a> database module.</p>
<p>Contains all the SQL related code. Most of the time you should not be importing this directly, unless you are a test case or want to do something evil. Instead use the exported procs from the <a class="reference external" href="l_main.html">l_main module</a>.</p>

<div class="section" id="6">
<h1><a class="toc-backref" href="#56">Imports</a></h1>
<dl class="item">
<a class="reference external" href="db_sqlite.html">db_sqlite</a>, <a class="reference external" href="times.html">times</a>, <a class="reference external" href="strutils.html">strutils</a>, <a class="reference external" href="l_types.html">l_types</a>, <a class="reference external" href="l_log.html">l_log</a>, <a class="reference external" href="streams.html">streams</a>, <a class="reference external" href="parsecsv.html">parsecsv</a>, <a class="reference external" href="parseutils.html">parseutils</a>, <a class="reference external" href="posix.html">posix</a>
</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#62">Procs</a></h1>
<dl class="item">
<dt id="open_database"><a name="open_database,"></a><pre><span class="Keyword">proc</span> <span class="Identifier">open_database</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">path</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span> <span class="Other">{.</span><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">EDb</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Creates or opens the database.</p>
<p>If the database doesn't exist it will be created.</p>
<p>Once the database has been opened, you should run update_database() on it.</p>


</dd>
<dt id="update"><a name="update,Tdb_conn"></a><pre><span class="Keyword">proc</span> <span class="Identifier">update</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">db_conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">)</span> <span class="Other">{.</span><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">EDb</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Run on an open database to update the schema and everything else needed.</p>
<p>If there is any problem updating the database, meaning that you should not continue, EDB will be raised.</p>


</dd>
<dt id="add_weight"><a name="add_weight,Tdb_conn,float,Weight_type,TTime"></a><pre><span class="Keyword">proc</span> <span class="Identifier">add_weight</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">;</span> <span class="Identifier">weight</span><span class="Other">:</span> <span class="Identifier">float</span><span class="Other">;</span> <span class="Identifier">typ</span><span class="Other">:</span> <span class="Identifier">Weight_type</span><span class="Other">;</span> 
                 <span class="Identifier">ddate</span><span class="Other">:</span> <span class="Identifier">TTime</span> <span class="Other">=</span> <span class="Identifier">TTime</span><span class="Other">(</span><span class="DecNumber">0</span><span class="Other">)</span><span class="Other">)</span><span class="Other">:</span> <span class="Keyword">tuple</span><span class="Other">[</span><span class="Identifier">w</span><span class="Other">:</span> <span class="Identifier">PWeight</span><span class="Other">,</span> <span class="Identifier">pos</span><span class="Other">:</span> <span class="Identifier">int</span><span class="Other">]</span> <span class="Other">{.</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Inserts a weight into the database.</p>
<p>If the proc succeeds and the just inserted weight can be read back, it returns the new PWeight object and the position it would have to be inserted into an array of weights.</p>
<p>If the proc fails, nil and negative are returned.</p>


</dd>
<dt id="remove_weight"><a name="remove_weight,Tdb_conn,PWeight"></a><pre><span class="Keyword">proc</span> <span class="Identifier">remove_weight</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">;</span> <span class="Identifier">weight</span><span class="Other">:</span> <span class="Identifier">PWeight</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">int64</span></pre></dt>
<dd>
<p>Removes the specified weight identifier, returns number of rows removed.</p>
<p>Look for a value greater than zero for success.</p>


</dd>
<dt id="update_weight"><a name="update_weight,Tdb_conn,PWeight,float,Weight_type"></a><pre><span class="Keyword">proc</span> <span class="Identifier">update_weight</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">;</span> <span class="Identifier">weight</span><span class="Other">:</span> <span class="Identifier">PWeight</span><span class="Other">;</span> <span class="Identifier">value</span><span class="Other">:</span> <span class="Identifier">float</span><span class="Other">;</span> 
                    <span class="Identifier">typ</span><span class="Other">:</span> <span class="Identifier">Weight_type</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">int64</span></pre></dt>
<dd>
<p>Modifies the value of the weight, returns the number of rows updated.</p>
<p>Note that <cite>weight</cite> is not updated, you have to do it yourself. Returns zero on failure.</p>


</dd>
<dt id="update_date"><a name="update_date,Tdb_conn,PWeight,TTime"></a><pre><span class="Keyword">proc</span> <span class="Identifier">update_date</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">;</span> <span class="Identifier">weight</span><span class="Other">:</span> <span class="Identifier">PWeight</span><span class="Other">;</span> <span class="Identifier">value</span><span class="Other">:</span> <span class="Identifier">TTime</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">int</span> <span class="Other">{.</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Modifies the value of the weight, returns its new position in the table.</p>
<p>Note that <cite>weight</cite> is not updated, you have to do it yourself. Returns negative on error.</p>


</dd>
<dt id="get_num_weights"><a name="get_num_weights,Tdb_conn"></a><pre><span class="Keyword">proc</span> <span class="Identifier">get_num_weights</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">int</span></pre></dt>
<dd>
<p>Returns the number of entries in the Weight table.</p>
<p>If the function succeeds, returns the zero or positive value, if something goes wrong a negative value is returned.</p>


</dd>
<dt id="get_weights_page"><a name="get_weights_page,Tdb_conn"></a><pre><span class="Keyword">proc</span> <span class="Identifier">get_weights_page</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">Tdb_conn</span><span class="Other">;</span> <span class="Identifier">last_known_id</span> <span class="Other">=</span> <span class="Operator">-</span> <span class="DecNumber">1</span><span class="Other">;</span> <span class="Identifier">page_size</span> <span class="Other">=</span> <span class="DecNumber">5</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span>
    <span class="Identifier">PWeight</span><span class="Other">]</span> <span class="Other">{.</span><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Returns the weights just below the specified identifier.</p>
<p>Pass a negative identifier to retrieve the &quot;top&quot; of the table, used when you don't know yet the highest identifier.</p>


</dd>
<dt id="import_csv_into_db"><a name="import_csv_into_db,TDbConn,seq[PWeight],bool"></a><pre><span class="Keyword">proc</span> <span class="Identifier">import_csv_into_db</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">TDbConn</span><span class="Other">;</span> <span class="Identifier">values</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span><span class="Identifier">PWeight</span><span class="Other">]</span><span class="Other">;</span> <span class="Identifier">replace</span><span class="Other">:</span> <span class="Identifier">bool</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span class="Other">{.</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Imports the values into the database.</p>
<p>If replace is true, the database is first deleted. The input PWeight objects from <cite>values</cite> won't be modified, you have to fetche/refresh the whole database after this proc is done.</p>


</dd>
<dt id="timegm"><a name="timegm,Ttm"></a><pre><span class="Keyword">proc</span> <span class="Identifier">timegm</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">a1</span><span class="Other">:</span> <span class="Keyword">var</span> <span class="Identifier">Ttm</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">TTime</span> <span class="Other">{.</span><span class="Identifier">importc</span><span class="Other">,</span> <span class="Identifier">header</span><span class="Other">:</span> <span class="StringLit">&quot;&lt;time.h&gt;&quot;</span><span class="Other">.}</span></pre></dt>
<dd>


</dd>
<dt id="parse_csv"><a name="parse_csv,string"></a><pre><span class="Keyword">proc</span> <span class="Identifier">parse_csv</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">input_filename</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span><span class="Identifier">PWeight</span><span class="Other">]</span></pre></dt>
<dd>
<p>Returns the list of weights as read from the input file.</p>
<p>The imported time is considered according to USE_GMT_TIME.</p>


</dd>
<dt id="build_csv_file"><a name="build_csv_file,TDbConn,string"></a><pre><span class="Keyword">proc</span> <span class="Identifier">build_csv_file</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">conn</span><span class="Other">:</span> <span class="Identifier">TDbConn</span><span class="Other">;</span> <span class="Identifier">out_filename</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> <span class="Other">{.</span><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">.}</span></pre></dt>
<dd>
<p>Reads through the open database and dumps it to the specified file.</p>
<p>Returns true if the exportation was a success, false if there was any error.</p>


</dd>
<dt id="set_csv_export_gmt_time"><a name="set_csv_export_gmt_time,bool"></a><pre><span class="Keyword">proc</span> <span class="Identifier">set_csv_export_gmt_time</span><span class="Operator">*</span><span class="Other">(</span><span class="Identifier">use_gmt</span><span class="Other">:</span> <span class="Identifier">bool</span><span class="Other">)</span></pre></dt>
<dd>
<p>Sets the exportation to use getGMTime instead of getLocalTime.</p>
<p>This is a feature required for the unit tests to pass running in any timezone, but it is undesirable for the end user, as he tracks the data in his local time.</p>


</dd>

</dl></div>

</div>

<small>Generated: 2015-01-17 21:32:13 UTC</small>
</div>
</body>
</html>
